<!DOCTYPE html>
<html xmlns:ts="http://www.thymeleaf.org">
<head>
<title>Message Monitor</title>
<link type="text/css" href="/css/darkly.bootstrap.min.css" rel="stylesheet"/>
<style>
.bg-info {
	margin-bottom:10px;
	padding:2px 2px 2px 4px;
}
.auto-scroll {
	overflow: auto;
	height: 400px;
}
#status > h4 {
	display: none;
}
</style>
<script src="/js/jquery-3.2.1.min.js"></script>
<script>
/*<![CDATA[*/
$(document).ready(function() {
	setStatus("pending")
	var waitperiod = 5000;
	var maxMessages = 20;
	var paused = false;
	$("#btn-pause").click(function() {
		paused = true;
		waitperiod = 5000;
		setStatus("paused")
	})
	$("#btn-resume").click(function() {
		paused = false;
		setStatus("pending")
	})
	function checkMessages() {
		if (paused) {
			setTimeout(checkMessages, waitperiod)
			return
		}
		$.ajax("/messages", {
			dataType: "json",
			method: "GET",
			success: function(data, textStatus, req) {
				console.log(req);
				console.log(req.getAllResponseHeaders());
				if (data.length == 0) {
					return;
				}
				var msgType = data.type;
				var messages = data.data;
				if (messages.length == 0) {
					return;
				}
				var total = $("#messages > div").length + messages.length;
				var lastel = maxMessages - messages.length;
				if (lastel < 0) lastel = 0;
				$("#messages").find("div").slice(lastel, maxMessages + 1).remove();
				var count = 0;
				for (var el in messages) {
					if (el < maxMessages) {
						count++;
						console.log(JSON.stringify(messages[el]));
						$('<div class="bg-info">' + msgType + ": " + JSON.stringify(messages[el]) + '</div>').prependTo("#messages");
					}
				}
				console.log("Added " + count + " messages");
				waitperiod = 5000
				$("#status-text").text("");
				setStatus("up")
			},
			error: function(req, textStatus, errorThrown) {
				if (waitperiod < 30000) {
					waitperiod += 1000
				}
				console.log(req.getAllResponseHeaders());
				console.log("Check for messages failed, increasing wait to " + waitperiod)
				console.log("Err: " + textStatus + ": " + errorThrown);
				$("#status-text").text(textStatus + " (" + req.status + "): " + errorThrown);
				setStatus("down")
			},
			complete: function() {
				setTimeout(checkMessages, waitperiod)
			}
		})
	}
	
	setTimeout(function() {
		checkMessages();
	}, waitperiod)
})
function setStatus(status) {
	$("#status > h4").hide();
	$("#status > ." + status).show();
}
/*]]>*/
</script>
</head>
<body>
<div class="container">
	<h2>Message Monitor</h2>
	<div class="col-md-6">
		<h3>Actions</h3>
		<div class="btn-group">
			<button type="button" class="btn btn-default btn-sm" id="btn-pause">Pause</button>
			<button type="button" class="btn btn-default btn-sm" id="btn-resume">Resume</button>
		</div>
		<h3>Status</h3>
		<div id="status">
			<h4 class="up"><span class="label label-success">Connected</span></h4>
			<h4 class="down"><span class="label label-warning">Down</span></h4>
			<h4 class="paused"><span class="label label-info">Paused</span></h4>
			<h4 class="pending"><span class="label label-info">Pending</span></h4>
		</div>
		<div id="status-text"></div>
	</div>
	<div id="messages" class="col-md-6 auto-scroll">
	</div>
</div>
</body>
</html>